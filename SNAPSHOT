#!/bin/bash

# Variables
DAYS_OLD=7  # Change this to the number of days
REGION="eu-north-1"  # Change this to your AWS region

# Get the current date in seconds since epoch
CURRENT_DATE=$(date +%s)

# List all snapshots
SNAPSHOTS=$(aws ec2 describe-snapshots --owner-ids self --query 'Snapshots[*].{ID:SnapshotId,StartTime:StartTime}' --output text --region $REGION)

# Loop through each snapshot
echo "$SNAPSHOTS" | while read -r SNAPSHOT_ID START_TIME; do
    # Convert the snapshot start time to seconds since epoch
    SNAPSHOT_DATE=$(date -d "$START_TIME" +%s)

    # Calculate the age of the snapshot in days
    AGE=$(( (CURRENT_DATE - SNAPSHOT_DATE) / 86400 ))

    # Delete the snapshot if it is older than the specified number of days
    if [ $AGE -gt $DAYS_OLD ]; then
        echo "Deleting snapshot $SNAPSHOT_ID which is $AGE days old."
        aws ec2 delete-snapshot --snapshot-id $SNAPSHOT_ID --region $REGION
    fi
done
